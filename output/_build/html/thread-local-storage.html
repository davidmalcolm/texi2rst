

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Thread-Local Storage &mdash; gcc 6 documentation</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="gcc 6 documentation" href="index.html" />
    <link rel="up" title="Extensions to the C Language Family" href="extensions-to-the-c-language-family.html" />
    <link rel="next" title="&lt;no title&gt;" href="binary-constants-using-the-0b-prefix.html" />
    <link rel="prev" title="Unnamed Structure and Union Fields" href="unnamed-structure-and-union-fields.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="binary-constants-using-the-0b-prefix.html" title="&lt;no title&gt;"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="unnamed-structure-and-union-fields.html" title="Unnamed Structure and Union Fields"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">gcc 6 documentation</a> &raquo;</li>
          <li><a href="gcc.html" >Introduction</a> &raquo;</li>
          <li><a href="extensions-to-the-c-language-family.html" accesskey="U">Extensions to the C Language Family</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Thread-Local Storage</a><ul>
<li><a class="reference internal" href="#iso-iec-9899-1999-edits-for-thread-local-storage">ISO/IEC 9899:1999 Edits for Thread-Local Storage</a></li>
<li><a class="reference internal" href="#iso-iec-14882-1998-edits-for-thread-local-storage">ISO/IEC 14882:1998 Edits for Thread-Local Storage</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="unnamed-structure-and-union-fields.html"
                        title="previous chapter">Unnamed Structure and Union Fields</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="binary-constants-using-the-0b-prefix.html"
                        title="next chapter">&lt;no title&gt;</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/thread-local-storage.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="thread-local-storage">
<span id="thread-local"></span><h1>Thread-Local Storage<a class="headerlink" href="#thread-local-storage" title="Permalink to this headline">¶</a></h1>
<p id="index-0">TLS``__thread``Thread-local storage (TLS) is a mechanism by which variables
are allocated such that there is one instance of the variable per extant
thread.  The runtime model GCC uses to implement this originates
in the IA-64 processor-specific ABI, but has since been migrated
to other processors as well.  It requires significant support from
the linker (<strong class="command">ld</strong>), dynamic linker (<strong class="command">ld.so</strong>), and
system libraries (libc.so and libpthread.so), so it
is not available everywhere.</p>
<p>At the user level, the extension is visible with a new storage
class keyword: <tt class="docutils literal"><span class="pre">__thread</span></tt>.  For example:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">__thread</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">__thread</span> <span class="k">struct</span> <span class="n">state</span> <span class="n">s</span><span class="p">;</span>
<span class="k">static</span> <span class="n">__thread</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">__thread</span></tt> specifier may be used alone, with the <tt class="docutils literal"><span class="pre">extern</span></tt>
or <tt class="docutils literal"><span class="pre">static</span></tt> specifiers, but with no other storage class specifier.
When used with <tt class="docutils literal"><span class="pre">extern</span></tt> or <tt class="docutils literal"><span class="pre">static</span></tt>, <tt class="docutils literal"><span class="pre">__thread</span></tt> must appear
immediately after the other storage class specifier.</p>
<p>The <tt class="docutils literal"><span class="pre">__thread</span></tt> specifier may be applied to any global, file-scoped
static, function-scoped static, or static data member of a class.  It may
not be applied to block-scoped automatic or non-static data member.</p>
<p>When the address-of operator is applied to a thread-local variable, it is
evaluated at run time and returns the address of the current thread&#8217;s
instance of that variable.  An address so obtained may be used by any
thread.  When a thread terminates, any pointers to thread-local variables
in that thread become invalid.</p>
<p>No static initialization may refer to the address of a thread-local variable.</p>
<p>In C++, if an initializer is present for a thread-local variable, it must
be a <tt class="docutils literal"><span class="pre">constant-expression</span></tt>, as defined in 5.19.2 of the ANSI/ISO C++
standard.</p>
<p>See <a class="reference external" href="http://www.akkadia.org/drepper/tls.pdfELF">http://www.akkadia.org/drepper/tls.pdfELF</a> Handling For Thread-Local Storage for a detailed explanation of
the four thread-local storage addressing models, and how the runtime
is expected to function.</p>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<div class="section" id="iso-iec-9899-1999-edits-for-thread-local-storage">
<span id="c99-thread-local-edits"></span><h2>ISO/IEC 9899:1999 Edits for Thread-Local Storage<a class="headerlink" href="#iso-iec-9899-1999-edits-for-thread-local-storage" title="Permalink to this headline">¶</a></h2>
<p>The following are a set of changes to ISO/IEC 9899:1999 (aka C99)
that document the exact semantics of the language extension.</p>
<ul>
<li><p class="first">5.1.2  Execution environments</p>
<p>Add new text after paragraph 1</p>
<p>Within either execution environment, a <em class="dfn">thread</em> is a flow of
control within a program.  It is implementation defined whether
or not there may be more than one thread associated with a program.
It is implementation defined how threads beyond the first are
created, the name and type of the function called at thread
startup, and how threads may be terminated.  However, objects
with thread storage duration shall be initialized before thread
startup.</p>
</li>
<li><p class="first">6.2.4  Storage durations of objects</p>
<p>Add new text before paragraph 3</p>
<p>An object whose identifier is declared with the storage-class
specifier <tt class="docutils literal"><span class="pre">__thread</span></tt> has <em class="dfn">thread storage duration</em>.
Its lifetime is the entire execution of the thread, and its
stored value is initialized only once, prior to thread startup.</p>
</li>
<li><p class="first">6.4.1  Keywords</p>
<p>Add <tt class="docutils literal"><span class="pre">__thread</span></tt>.</p>
</li>
<li><p class="first">6.7.1  Storage-class specifiers</p>
<p>Add <tt class="docutils literal"><span class="pre">__thread</span></tt> to the list of storage class specifiers in
paragraph 1.</p>
<p>Change paragraph 2 to</p>
<p>With the exception of <tt class="docutils literal"><span class="pre">__thread</span></tt>, at most one storage-class
specifier may be given [...].  The <tt class="docutils literal"><span class="pre">__thread</span></tt> specifier may
be used alone, or immediately following <tt class="docutils literal"><span class="pre">extern</span></tt> or
<tt class="docutils literal"><span class="pre">static</span></tt>.</p>
<p>Add new text after paragraph 6</p>
<p>The declaration of an identifier for a variable that has
block scope that specifies <tt class="docutils literal"><span class="pre">__thread</span></tt> shall also
specify either <tt class="docutils literal"><span class="pre">extern</span></tt> or <tt class="docutils literal"><span class="pre">static</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">__thread</span></tt> specifier shall be used only with
variables.</p>
</li>
</ul>
</div>
<div class="section" id="iso-iec-14882-1998-edits-for-thread-local-storage">
<span id="c-98-thread-local-edits"></span><h2>ISO/IEC 14882:1998 Edits for Thread-Local Storage<a class="headerlink" href="#iso-iec-14882-1998-edits-for-thread-local-storage" title="Permalink to this headline">¶</a></h2>
<p>The following are a set of changes to ISO/IEC 14882:1998 (aka C++98)
that document the exact semantics of the language extension.</p>
<ul>
<li><p class="first">[intro.execution]</p>
<p>New text after paragraph 4</p>
<p>A <em class="dfn">thread</em> is a flow of control within the abstract machine.
It is implementation defined whether or not there may be more than
one thread.</p>
<p>New text after paragraph 7</p>
<p>It is unspecified whether additional action must be taken to
ensure when and whether side effects are visible to other threads.</p>
</li>
<li><p class="first">[lex.key]</p>
<p>Add <tt class="docutils literal"><span class="pre">__thread</span></tt>.</p>
</li>
<li><p class="first">[basic.start.main]</p>
<p>Add after paragraph 5</p>
<p>The thread that begins execution at the <tt class="docutils literal"><span class="pre">main</span></tt> function is called
the <em class="dfn">main thread</em>.  It is implementation defined how functions
beginning threads other than the main thread are designated or typed.
A function so designated, as well as the <tt class="docutils literal"><span class="pre">main</span></tt> function, is called
a <em class="dfn">thread startup function</em>.  It is implementation defined what
happens if a thread startup function returns.  It is implementation
defined what happens to other threads when any thread calls <tt class="docutils literal"><span class="pre">exit</span></tt>.</p>
</li>
<li><p class="first">[basic.start.init]</p>
<p>Add after paragraph 4</p>
<p>The storage for an object of thread storage duration shall be
statically initialized before the first statement of the thread startup
function.  An object of thread storage duration shall not require
dynamic initialization.</p>
</li>
<li><p class="first">[basic.start.term]</p>
<p>Add after paragraph 3</p>
<p>The type of an object with thread storage duration shall not have a
non-trivial destructor, nor shall it be an array type whose elements
(directly or indirectly) have non-trivial destructors.</p>
</li>
<li><p class="first">[basic.stc]</p>
<p>Add &#8216;thread storage duration&#8217; to the list in paragraph 1.</p>
<p>Change paragraph 2</p>
<p>Thread, static, and automatic storage durations are associated with
objects introduced by declarations [...].</p>
<p>Add <tt class="docutils literal"><span class="pre">__thread</span></tt> to the list of specifiers in paragraph 3.</p>
</li>
<li><p class="first">[basic.stc.thread]</p>
<p>New section before [basic.stc.static]</p>
<p>The keyword <tt class="docutils literal"><span class="pre">__thread</span></tt> applied to a non-local object gives the
object thread storage duration.</p>
<p>A local variable or class data member declared both <tt class="docutils literal"><span class="pre">static</span></tt>
and <tt class="docutils literal"><span class="pre">__thread</span></tt> gives the variable or member thread storage
duration.</p>
</li>
<li><p class="first">[basic.stc.static]</p>
<p>Change paragraph 1</p>
<p>All objects that have neither thread storage duration, dynamic
storage duration nor are local [...].</p>
</li>
<li><p class="first">[dcl.stc]</p>
<p>Add <tt class="docutils literal"><span class="pre">__thread</span></tt> to the list in paragraph 1.</p>
<p>Change paragraph 1</p>
<p>With the exception of <tt class="docutils literal"><span class="pre">__thread</span></tt>, at most one
<tt class="docutils literal"><span class="pre">storage-class-specifier</span></tt> shall appear in a given
<tt class="docutils literal"><span class="pre">decl-specifier-seq</span></tt>.  The <tt class="docutils literal"><span class="pre">__thread</span></tt> specifier may
be used alone, or immediately following the <tt class="docutils literal"><span class="pre">extern</span></tt> or
<tt class="docutils literal"><span class="pre">static</span></tt> specifiers.  [...]</p>
<p>Add after paragraph 5</p>
<p>The <tt class="docutils literal"><span class="pre">__thread</span></tt> specifier can be applied only to the names of objects
and to anonymous unions.</p>
</li>
<li><p class="first">[class.mem]</p>
<p>Add after paragraph 6</p>
<p>Non-<tt class="docutils literal"><span class="pre">static</span></tt> members shall not be <tt class="docutils literal"><span class="pre">__thread</span></tt>.</p>
</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="binary-constants-using-the-0b-prefix.html" title="&lt;no title&gt;"
             >next</a> |</li>
        <li class="right" >
          <a href="unnamed-structure-and-union-fields.html" title="Unnamed Structure and Union Fields"
             >previous</a> |</li>
        <li><a href="index.html">gcc 6 documentation</a> &raquo;</li>
          <li><a href="gcc.html" >Introduction</a> &raquo;</li>
          <li><a href="extensions-to-the-c-language-family.html" >Extensions to the C Language Family</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, gcc peeps.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>